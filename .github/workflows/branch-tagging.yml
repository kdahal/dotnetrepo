name: Build and Tag new-tagging-branch

on:
  push:
    branches:
      - new-tagging-branch

jobs:
  build-and-tag:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@github.com"

      - name: Create or Update new-tagging-branch Branch
        run: |
          if git show-ref --quiet refs/heads/new-tagging-branch; then
            echo "new-tagging-branch branch exists. Checking out..."
              git checkout new-tagging-branch
            else
              echo "Creating new-tagging-branch branch..."
              git checkout -b new-tagging-branch
            fi

      - name: Auto Increment Tag
        run: |
          # Fetch all tags
          git fetch --tags
        
          # Get the latest new-tagging-branch tag
          latest_tag=$(git tag -l "new-tagging-branch-*" --sort=-v:refname | head -n 1)
            
          # If no tag exists, start from new-tagging-branch-1.0.0
          if [[ -z "$latest_tag" ]]; then
            new_tag="new-tagging-branch-1.0.0"
          else
            # Extract numeric version components
          version=$(echo "$latest_tag" | sed 's/new-tagging-branch-//')
            IFS='.' read -r major minor patch <<< "$version"
              
          # Increment patch version
            new_tag="new-tagging-branch-${major}.${minor}.$((patch + 1))"
          fi
        
            echo "New Tag: $new_tag"
            echo "TAG_NAME=$new_tag" >> $GITHUB_ENV
        
      - name: Push new-tagging-branch Branch and Tag
        run: |
          git push origin new-tagging-branch
          git tag $TAG_NAME
          git push origin $TAG_NAME

